<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×‘×“×™×§×ª ×¨×™×§×•×œ×™× ×œ×¨×›×‘ | ××©×¨×“ ×”×ª×—×‘×•×¨×”</title>
    
    <!-- Fonts & Styles -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        body { font-family: 'Rubik', sans-serif; }
        
        .il-plate-container {
            background-color: #FFCC00; border: 2px solid #333; border-radius: 8px;
            position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            max-width: 320px; margin: 0 auto; display: flex; align-items: center; height: 70px;
        }
        .il-blue-strip {
            background-color: #003399; width: 45px; height: 100%;
            border-top-right-radius: 5px; border-bottom-right-radius: 5px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; font-size: 11px; font-weight: bold; position: absolute; left: 0; top: 0; z-index: 10;
        }
        .il-input {
            background: transparent; border: none; width: 100%; height: 100%;
            text-align: center; font-size: 2.5rem; font-weight: 900; color: #333;
            letter-spacing: 4px; outline: none; padding-left: 50px; font-family: 'Rubik', sans-serif;
        }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .loader {
            border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid #fff;
            width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-left: 8px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Header -->
    <header class="bg-white shadow-sm pt-12 pb-16 px-4 text-center relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-600 via-purple-600 to-blue-600"></div>
        <h1 class="text-4xl md:text-5xl font-black text-slate-900 mb-4 tracking-tight">×”×× ×”×¨×›×‘ ×©×œ×š ×‘×˜×•×—?</h1>
        <p class="text-xl text-slate-600 mb-10 max-w-2xl mx-auto font-light">×‘×“×™×§×ª ×¨×™×§×•×œ×™× ××œ××” ×›×•×œ×œ ×¤×¨×˜×™ ×™×‘×•××Ÿ ×•××•×¤×Ÿ ×”×ª×™×§×•×Ÿ.</p>

        <div class="mb-8">
            <div class="il-plate-container">
                <div class="il-blue-strip"><span>IL</span><div class="w-5 h-3 bg-white rounded-[1px] mt-1 opacity-90"></div><span>×™×©×¨××œ</span></div>
                <input type="text" inputmode="numeric" pattern="[0-9]*" id="plateInput" class="il-input" placeholder="12345678" maxlength="8">
            </div>
            <p class="text-sm text-gray-400 mt-2">×”×–×Ÿ ××¡×¤×¨ ×¨×›×‘ (7 ××• 8 ×¡×¤×¨×•×ª)</p>
        </div>

        <button id="searchBtn" onclick="checkCar()" class="bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-bold py-3 px-10 rounded-full shadow-lg transition-all transform hover:-translate-y-1 text-lg flex items-center justify-center mx-auto">
            ×‘×“×™×§×ª ×¨×›×‘ 
        </button>

        <div id="resultArea" class="mt-10 max-w-4xl mx-auto hidden transition-all duration-500 ease-in-out"></div>
    </header>

    <!-- Info Section -->
    <main class="max-w-5xl mx-auto px-4 py-12 space-y-20">
        <div class="text-center">
            <h2 class="text-3xl font-bold text-slate-900">× ×ª×•× ×™× ××”×©×˜×—</h2>
            <div class="w-16 h-1.5 bg-blue-600 mx-auto mt-4 rounded-full"></div>
        </div>
        <div class="grid md:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100 text-center">
                <div class="h-48 bg-slate-100 rounded-xl flex items-center justify-center mb-4"><span class="text-5xl opacity-20">ğŸ“Š</span></div>
                <h3 class="text-xl font-bold text-slate-800">×¡×˜×˜×™×¡×˜×™×§×•×ª ×™×¦×¨× ×™×</h3>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100 text-center">
                <div class="h-48 bg-slate-100 rounded-xl flex items-center justify-center mb-4"><span class="text-5xl opacity-20">ğŸ”§</span></div>
                <h3 class="text-xl font-bold text-slate-800">××™×“×¢ ×˜×›× ×™</h3>
            </div>
        </div>
    </main>

    <footer class="bg-slate-900 text-slate-400 text-center py-8 mt-12 border-t border-slate-800">
        <p class="text-sm">×”××™×“×¢ ××‘×•×¡×¡ ×¢×œ ×××’×¨ ×”××™×“×¢ ×”×××©×œ×ª×™ (Data.gov.il).</p>
    </footer>

    <script>
        const dataCache = {};
        let infoDataCache = null; // To store the big info file once loaded

        function checkCar() {
            const inputField = document.getElementById('plateInput');
            const resultDiv = document.getElementById('resultArea');
            const btn = document.getElementById('searchBtn');
            
            let input = inputField.value.replace(/[^0-9]/g, '').trim();
            
            resultDiv.innerHTML = '';
            resultDiv.classList.add('hidden');

            if(!input || input.length < 6) {
                alert('× × ×œ×”×–×™×Ÿ ××¡×¤×¨ ×¨×›×‘ ×ª×§×™×Ÿ');
                return;
            }

            // Handle 7 vs 8 digits logic
            if (input.length === 7) input = "0" + input;

            // UI State
            btn.innerHTML = '<div class="loader"></div> ××—×¤×©...';
            btn.disabled = true;
            inputField.disabled = true;

            const lastDigit = input.slice(-1);
            const splitFile = `split_data/data_${lastDigit}.csv`;
            const infoFile = `split_data/recalls_info.csv`; // This file has the contacts

            const resetUI = () => {
                btn.innerText = "×‘×“×™×§×ª ×¨×›×‘";
                btn.disabled = false;
                inputField.disabled = false;
            };

            // STEP 1: Load the car list (split file)
            const loadSplitFile = () => {
                if (dataCache[lastDigit]) {
                    processCarList(dataCache[lastDigit]);
                } else {
                    Papa.parse(splitFile, {
                        download: true, 
                        header: true, 
                        skipEmptyLines: true,
                        complete: (results) => {
                            dataCache[lastDigit] = results.data;
                            processCarList(results.data);
                        },
                        error: (err) => {
                            console.error(err);
                            alert("×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×. ×•×•×“× ×©×”×§×‘×¦×™× ×”×•×¢×œ×• ×œ×’×™×˜×”××‘.");
                            resetUI();
                        }
                    });
                }
            };

            // STEP 2: Filter car list and if found, load info file
            const processCarList = (data) => {
                const searchInt = parseInt(input, 10);
                
                // Find plate column safely
                const keys = Object.keys(data[0]);
                const plateKey = keys.find(k => k.includes('MISPAR_RECHEV'));
                
                if (!plateKey) { alert("×©×’×™××ª × ×ª×•× ×™×: ×—×¡×¨×” ×¢××•×“×ª ××¡×¤×¨ ×¨×›×‘"); resetUI(); return; }

                const foundVehicles = data.filter(row => {
                    const rowVal = row[plateKey];
                    return rowVal && parseInt(String(rowVal).trim(), 10) === searchInt;
                });

                if (foundVehicles.length === 0) {
                    // Nothing found - show green success message immediately
                    renderResults([], input); 
                    resetUI();
                } else {
                    // Found something! Now fetch contact info
                    loadInfoFile(foundVehicles);
                }
            };

            // STEP 3: Load the detailed Info File
            const loadInfoFile = (foundVehicles) => {
                if (infoDataCache) {
                    mergeAndRender(foundVehicles, infoDataCache);
                } else {
                    console.log("Downloading Info File...");
                    Papa.parse(infoFile, {
                        download: true,
                        header: true,
                        delimiter: '|', // CRITICAL: Info file uses Pipe separator
                        skipEmptyLines: true,
                        complete: (results) => {
                            infoDataCache = results.data;
                            mergeAndRender(foundVehicles, results.data);
                        },
                        error: (err) => {
                            console.error("Info file error:", err);
                            // Render what we have even if info file fails
                            renderResults(foundVehicles, input); 
                            resetUI();
                        }
                    });
                }
            };

            // STEP 4: Join the tables
            const mergeAndRender = (vehicles, infoData) => {
                const finalData = vehicles.map(v => {
                    // Find matching row in infoData by RECALL_ID
                    // We use vague matching because sometimes csvs have invisible spaces
                    const info = infoData.find(i => String(i.RECALL_ID).trim() === String(v.RECALL_ID).trim());
                    
                    return {
                        ...v, // Keep original data
                        // Add new data (or default to empty if not found)
                        YEVUAN_TEUR: info ? info.YEVUAN_TEUR : '×œ× ×™×“×•×¢',
                        TELEPHONE: info ? info.TELEPHONE : '',
                        WEBSITE: info ? info.WEBSITE : '',
                        OFEN_TIKUN: info ? info.OFEN_TIKUN : '×¤× ×” ×œ×™×‘×•××Ÿ ×œ×§×‘×œ×ª ×¤×¨×˜×™×'
                    };
                });
                
                renderResults(finalData, input);
                resetUI();
            };
            
            // Start the chain
            loadSplitFile();
        }

        function renderResults(foundVehicles, input) {
            const resultDiv = document.getElementById('resultArea');
            resultDiv.classList.remove('hidden');

            if(foundVehicles.length > 0) {
                let html = `
                    <div class="bg-red-50 border-2 border-red-100 rounded-2xl p-6 shadow-xl animate-fade-in text-right">
                        <div class="flex items-center border-b border-red-200 pb-4 mb-4">
                            <span class="text-3xl ml-3">âš ï¸</span>
                            <div>
                                <h3 class="text-2xl font-black text-red-800">× ××¦××• ×§×¨×™××•×ª ×©×™×¨×•×ª ×¤×ª×•×—×•×ª</h3>
                                <p class="text-red-600">×¨×›×‘ ××¡×¤×¨: <span class="font-mono font-bold">${input}</span></p>
                            </div>
                        </div>
                        
                        <div class="space-y-6">
                `;

                foundVehicles.forEach((v, index) => {
                    // Detect key names dynamically for the base object just in case
                    const k = Object.keys(v);
                    const recallId = v['RECALL_ID'] || v[k.find(key => key.includes('RECALL_ID'))] || '-';
                    const type = v['SUG_RECALL'] || '-';
                    const issue = v['TEUR_TAKALA'] || v['SUG_TAKALA'] || '-';
                    const date = v['TAARICH_PTICHA'] || '-';
                    const fix = v['OFEN_TIKUN'] || '-';
                    const importer = v['YEVUAN_TEUR'] || '-';
                    const phone = v['TELEPHONE'] ? v['TELEPHONE'].replace(/[^0-9*]/g, '') : '';
                    const website = v['WEBSITE'] || '#';

                    html += `
                        <div class="bg-white rounded-xl border border-red-100 overflow-hidden shadow-sm">
                            <div class="bg-red-100/50 px-4 py-2 border-b border-red-100 flex justify-between items-center">
                                <span class="font-bold text-red-800 text-sm">×§×¨×™××” ××¡' ${index + 1}</span>
                                <span class="text-xs bg-white px-2 py-1 rounded border border-red-200 font-mono">ID: ${recallId}</span>
                            </div>
                            
                            <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-xs text-gray-500">××”×•×ª ×”×ª×§×œ×”</p>
                                    <p class="font-bold text-gray-800">${issue}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">××•×¤×Ÿ ×”×ª×™×§×•×Ÿ</p>
                                    <p class="text-gray-800">${fix}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">×¡×•×’ ×¨×™×§×•×œ</p>
                                    <p class="text-gray-800">${type}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">×ª××¨×™×š ×¤×ª×™×—×”</p>
                                    <p class="text-gray-800">${date}</p>
                                </div>
                            </div>

                            <!-- Contact Section -->
                            <div class="bg-slate-50 p-4 border-t border-slate-100">
                                <p class="text-xs text-gray-500 mb-2">×¤×¨×˜×™ ×™×‘×•××Ÿ: <strong>${importer}</strong></p>
                                <div class="flex gap-3">
                                    ${phone ? `
                                    <a href="tel:${phone}" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg text-center font-bold text-sm flex items-center justify-center gap-2 transition">
                                        <span>ğŸ“</span> ×—×™×•×’ (${v['TELEPHONE']})
                                    </a>` : ''}
                                    
                                    ${website && website.length > 5 ? `
                                    <a href="${website.startsWith('http') ? website : 'https://'+website}" target="_blank" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg text-center font-bold text-sm flex items-center justify-center gap-2 transition">
                                        <span>ğŸŒ</span> ××ª×¨ ××™× ×˜×¨× ×˜
                                    </a>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                        <div class="mt-6 text-center">
                            <p class="text-sm text-gray-500">×—×•×‘×” ×œ×’×©×ª ×œ××•×¡×š ×”×™×‘×•××Ÿ ×œ×‘×™×¦×•×¢ ×”×ª×™×§×•×Ÿ.</p>
                        </div>
                    </div>
                `;
                resultDiv.innerHTML = html;
            } else {
                // Success State
                resultDiv.innerHTML = `
                    <div class="bg-emerald-50 border-2 border-emerald-100 rounded-2xl p-8 text-center shadow-xl animate-fade-in">
                        <div class="bg-emerald-100 w-20 h-20 mx-auto rounded-full flex items-center justify-center mb-4">
                            <span class="text-4xl">âœ…</span>
                        </div>
                        <h3 class="font-black text-2xl text-emerald-800 mb-2">×”×›×œ ×ª×§×™×Ÿ!</h3>
                        <p class="text-emerald-700 text-lg">×œ× × ××¦××• ×§×¨×™××•×ª ×©×™×¨×•×ª ×¤×ª×•×—×•×ª ×œ×¨×›×‘ <strong class="font-mono">${input}</strong>.</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
